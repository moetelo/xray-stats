#!/bin/env bash

set -eo pipefail

source "$(dirname "$0")/stats-utils.sh"

isPlainOutput=false
if [ "$1" == "--plain" ]; then
    isPlainOutput=true
    shift
fi

queryDate=${1:-$(date +%F)}

if [ "$isPlainOutput" = true ]; then
    echo "user down_bytes up_bytes"
else
    echo -e "\033[1;33mDate:  \033[1;0m$queryDate\033[1;0m"
    echo
    echo -e "           \033[1;34m↓ down (mb) \033[1;32m↑ up (mb)\033[1;0m"
fi

for user in "$TRAFFIC_DIR"/*; do
    down=$(sum-num-file "$user/down/$queryDate")
    up=$(sum-num-file "$user/up/$queryDate")

    down=${down:-0}
    up=${up:-0}
    username=$(basename "$user")
    if [ "$isPlainOutput" = true ]; then
        echo "$username $down $up"
        continue
    fi

    downMb=$((down / 1024 / 1024))
    upMb=$((up / 1024 / 1024))
    printf "%-10s \033[1;34m%10s \033[1;32m%10s\033[1;0m\n" "$username" "$downMb" "$upMb"
done
